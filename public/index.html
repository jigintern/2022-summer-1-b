<!DOCTYPE html>
<html lang="jp">
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <meta charset="UTF-8">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <title>テスト入力フォーム</title>
</head>

<body>
    <div class="all-item">
        <div class="navigation">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <a class="navbar-brand" href="/index.html">Vending Machine Searcher(仮)</a>
                </div>
                <button id="signUp" class="col-1 me-3 btn btn-outline-secondary" type="button">サインアップ</button>
                <a id="signIn" href="/signin.html" class="col-1" style="text-align: center">サインイン</a>
            </nav>
        </div>

        <div class="main">
            <div class="sidebar">
                <h1>テスト入力フォーム</h1>

                <div class="col-10 mb-3">
                    <label for="userNameInput" class="form-label"><b>名前</b></label>
                    <input type="text" class="form-control" id="userNameInput">
                </div>

                <div class="col-6 mb-3">
                    <label for="latitudeInput">
                        <span class="required">*</span>
                        <span><b>緯度</b></span> <br>
                    </label>
                    <input type="number" class="form-control" id ="latitudeInput" min="-90.0" max="90.0" step="0.0000001" required>
                </div>

                <div class="col-6 mb-3">
                    <label for="longitudeInput">
                        <span class="required">*</span>
                        <span><b>経度</b></span> <br>
                    </label>
                    <input type="number" class="form-control" id ="longitudeInput" min="-180.0" max="180.0" step="0.0000001" required>
                </div>

                <div class="col-4 mb-3">
                    <button id="getLocation" class="btn btn-secondary">現在位置を取得</button>
                </div>

                <div class="col-6 mb-3">
                    <label for="photoInput">
                        <span class="required">*</span>
                        <span><b>自動販売機の写真</b></span>
                    </label>
                    <input type="file" class="form-control" id="photoInput" accept="image/*" onchange="postImage(event)" required>

                    <img id="thumbnail" class="img-thumbnail" alt="サムネイル" src="" hidden>
                </div>

                <div class="col-4 mb-3">
                    <button id="sendForm" class="btn btn-success" disabled>送信</button>
                </div>

                <div class="col-4 mb-3">
                    <label for="debug"><span><b>デバッグ用</b></span></label>
                    <textarea id="debug" class="form-control" rows="15" cols="60"></textarea>
                </div>
            </div>

            <div class="map">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script type="module">
      // ランダムなUUIDの生成
      function randomUUID(){
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(a) {
            let r = (new Date().getTime() + Math.random() * 16)%16 | 0, v = a === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
      }
        $(function () {
            // 要素
            const elemUserName = $("#userNameInput");
            const elemLatitude = $("#latitudeInput");
            const elemLongitude = $("#longitudeInput");
            const elemPhoto = $("#photoInput");
            const elemSendForm = $("#sendForm");

            elemPhoto.on("change", checkEmpty);
            elemLatitude.on("input", checkEmpty);
            elemLongitude.on("input", checkEmpty);

            // Cookie からユーザーIDを取得
            const array = document.cookie.split(";");
            let user_id = "";
            for (const c of array) {
                const split = c.split("=");
                const key = split[0];
                const value = split[1];

                if (key === "user_id") {
                    user_id = value;
                    break;
                }
            }

            // 「サインイン」について
            const signIn = $("#signIn");
            const signUp = $("#signUp");

            // 「サインアップ」ボタンでリダイレクト
            signUp.on("click", function () {
                if (user_id.length >= 1) {
                    $.ajax({
                        url: "/signout",
                        type: "POST",
                        async: true
                    });

                    document.cookie = "user_id=;";
                    window.location.href = "/index.html";
                } else {
                    window.location.href = "/signup.html";
                }
            });

            // サインアップ済みの場合の変更
            if (user_id.length >= 1) {
                signUp.text("サインアウト");
                signUp.prop("class", "col-2 me-3 btn btn-outline-danger");
                signIn.text(user_id + " さん");
                signIn.removeAttr("href");
                elemUserName.val(user_id);
            }

            // 入力必須な項目が空かどうかを判定する
            function checkEmpty() {
                const b1 = elemLatitude.val().length > 0;
                const b2 = elemLongitude.val().length > 0;
                const b3 = elemPhoto.prop("files").length > 0;

                elemSendForm.prop("disabled", !(b1 && b2 && b3));
            }

            // 「現在位置を取得」ボタンを押すと実行される
            $("#getLocation").on("click", function () {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                };

                function success(pos) {
                    const coords = pos.coords;
                    document.querySelector("#latitudeInput").value = coords.latitude;
                    document.querySelector("#longitudeInput").value = coords.longitude;
                    mymap.setView([coords.latitude, coords.longitude], 17);
                }

                function error(err) {
                    const msg = "位置情報の取得に失敗しました\n" + `Error Code: ${err.code}\n` + `${err.message}`
                    alert(msg);
                }

                navigator.geolocation.getCurrentPosition(success, error, options);

                checkEmpty();
            });

            // 「送信」ボタンを押すと実行される
            elemSendForm.on("click", function () {
                // 要素
                let id = 0;
                const user_id = $("#userNameInput").val();
                const lat = $("#latitudeInput").val();
                const long = $("#longitudeInput").val();
                const photo = randomUUID();
                const formatted = new Date().toISOString();
                const date = formatted.split(".")[0];

                $.ajax({
                    url: "/posts",
                    type: "GET",
                    async: true
                }).done(function (msg) {
                    const tmp = JSON.stringify(msg);
                    const json = JSON.parse(tmp);
                    id = json.length + 1;

                    const jsonString = JSON.stringify({id, user_id, lat, long, photo, date});
                    $.ajax({
                        url: "/posts",
                        type: "POST",
                        async: true,
                        contentType: "application/json",
                        data: jsonString,
                        dataType: "json"
                    });

                    $("#debug").val(jsonString);
                });
            });

          var testList = [
            {
              "user_id": "hoge-hoge",
              "lat": "35",
              "long": "135",
              "photo": "codimg.png",
              "date": "1/1"
            },
            {
              "user_id": "huge-huge",
              "lat": "35.710049612769694",
              "long": "139.81072185539296",
              "photo": "https://tderfuecifzjrpfwsplc.supabase.co/storage/v1/object/public/hogehoge/test.jpeg",
              "date": "12/31"
            }
          ];

          var mymap = L.map('map');
          // タイルレイヤーを作成し、地図にセットする
          L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">国土地理院</a>',
          }).addTo(mymap);
                //markerListの設定でマーカーを追加
          for (var num in testList) {
            var test = testList[num];
            var content = "<img src= "+ test.photo +" width='300' height='flex'>"
            var popup = L.popup({maxWidth:350}).setContent(content);
            L.marker([test.lat, test.long], { title: test.user_id }).bindPopup(popup).addTo(mymap);
          }
          // 地図の中心座標とズームレベルを設定する
          mymap.setView([35.943306, 136.200500], 17);

        });
    </script>
</body>

<script>
  async function postImage(event) {
    const rawFile = event.target.files[0];
    const reader = new FileReader();
    reader.onload = async () => {
      console.log(reader.result);
      const response = await fetch(
          "posts/image",
          {
              method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ file: reader.result })
          }
      );
    };
    reader.readAsDataURL(rawFile);
  } 
</script>

</html>