<!DOCTYPE html>
<html lang="jp">

<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css">

    <meta charset="UTF-8">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <title>ãƒ†ã‚¹ãƒˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </title>
</head>

<body>
<div class="all-item">
    <div class="navigation">
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="/index.html">Vending Machine Searcher</a>
            </div>
            <button id="signUp" class="col-1 me-3 btn btn-outline-secondary" type="button">ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</button>
            <a id="signIn" href="/signin.html" class="col-1" style="text-align: center">ã‚µã‚¤ãƒ³ã‚¤ãƒ³</a>
        </nav>
    </div>

    <div class="main">
        <div class="sidebar">
            <h1>â›½è‡ªè²©æ©Ÿã‚’ç™»éŒ²</h1>

            <div class="col-6 mb-3">
                <label for="userNameInput" class="form-label"><b>ğŸ¹åå‰</b></label>
                <input type="text" class="form-control" id="userNameInput" placeholder="ä¾‹) ã‚¿ãƒŠã‚«ã€€ã‚¿ãƒ­ã‚¦">
            </div>

            <div class="col-6 mb-3">
                <label for="latitudeInput">
                    <span class="required">*</span>
                    <span class="form-title"><b>ğŸ¸ç·¯åº¦</b></span> <br>
                </label>
                <input type="number" class="form-control" id ="latitudeInput" min="-90.0" max="90.0" step="0.0000001" placeholder="ä¾‹) 35.6323207" required>
            </div>

            <div class="col-6 mb-3">
                <label for="longitudeInput">
                    <span class="required">*</span>
                    <span class="form-title"><b>ğŸ§ƒçµŒåº¦</b></span> <br>
                </label>
                <input type="number" class="form-control" id ="longitudeInput" min="-180.0" max="180.0" step="0.0000001" placeholder="ä¾‹) 139.8789308" required>
            </div>

            <div class="col-4 mb-3">
                <button id="getLocation" class="btn btn-secondary">ç¾åœ¨ä½ç½®ã‚’å–å¾—</button>
            </div>

            <div class="col-8 mb-3">
                <label for="photoInput">
                    <span class="required">*</span>
                    <span class="form-title"><b>ğŸ“¸è‡ªå‹•è²©å£²æ©Ÿã®å†™çœŸ</b></span>
                </label>
                <input type="file" class="form-control" id="photoInput" accept="image/*" required>

                <img id="thumbnail" class="img-thumbnail" alt="ã‚µãƒ ãƒã‚¤ãƒ«" src="" hidden>
            </div>

            <div class="mb-5">
                <button id="sendForm" class="col-2 me-3 btn btn-success" disabled>é€ä¿¡</button>

                <div id="successMessage" class="col-6 fade-in" style="color: green; display: none">
                    <p>
                        <span><i class="bi-check-circle-fill"></i></span>
                        <span><b>æŠ•ç¨¿ã«æˆåŠŸã—ã¾ã—ãŸ</b></span>
                    </p>
                </div>
            </div>

            <div class="mb-3">
                <label for="pinsTable">
                    <span><i class="bi-chat-left-text-fill"></i></span>
                    <span><b>æŠ•ç¨¿ä¸€è¦§</b></span>
                </label>
                <table id="pinsTable" class="table table-light table-bordered table-striped table-sm col-12">
                    <thead>
                    <tr style="text-align: center">
                        <th scope="col">#</th>
                        <th scope="col">ç”»åƒ</th>
                        <th scope="col">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
                        <th scope="col">ç·¯åº¦</th>
                        <th scope="col">çµŒåº¦</th>
                        <th scope="col">æŠ•ç¨¿æ—¥æ™‚</th>
                    </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="map">
            <div id="map"></div>
        </div>
    </div>

    <div class="shosai">
        <p >ãƒ”ãƒ³ã®æƒ…å ±</p>
        <div id ='user'></div>
        <div id ='lat'></div>
        <div id ='lng'></div>
        <div id ='date'></div>
    </div>
</div>

<script type="module">
    $(function () {
        // è¡¨ã«è¦ç´ ã‚’è¿½åŠ ã™ã‚‹
        $.ajax("/posts", {
            type: "GET",
            dataType: "json"
        }).done(function (data) {
            const body = $("#tableBody");

            const jsonString = JSON.stringify(data);
            const json = JSON.parse(jsonString);

            console.log("json.length = " + json.length);

            for (let id = 0; id < json.length; id++) {
                const photo = json[id]["photo"];
                const user_id = json[id]["user_id"];
                const lat = json[id]["lat"];
                const long = json[id]["long"];
                const date = json[id]["date"];

                body.append(`
                        <tr style="text-align: center">
                            <th scope='row'> ` + (id + 1) + ` </th>
                            <td><img src="${photo}" style="width: auto; height: auto; max-width: 128px; max-height: 128px" alt="Posted Image"></td>
                            <td>${user_id}</td>
                            <td>${lat}</td>
                            <td>${long}</td>
                            <td>${date}</td>
                        </tr>
                    `);
            }
        });

        let photo = "";
        let mymap;

        // å†™çœŸã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function postImage(event) {
            const rawFile = event.target.files[0];
            const reader = new FileReader();
            reader.onload = async () => {
                console.log(reader.result);
                const response = await fetch(
                    "posts/image",
                    {
                        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ file: reader.result })
                    }
                );

                photo = await response.text();
            };

            reader.readAsDataURL(rawFile);
        }

        // è¦ç´ 
        const elemUserName = $("#userNameInput");
        const elemLatitude = $("#latitudeInput");
        const elemLongitude = $("#longitudeInput");
        const elemPhoto = $("#photoInput");
        const elemSendForm = $("#sendForm");

        elemPhoto.on("change", function () {
            checkEmpty();
            postImage(event);
        });

        elemLatitude.on("input", checkEmpty);
        elemLongitude.on("input", checkEmpty);

        // Cookie ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
        const array = document.cookie.split(";");
        let user_id = "";
        for (const c of array) {
            const split = c.split("=");
            const key = split[0];
            const value = split[1];

            if (key === "user_id") {
                user_id = value;
                break;
            }
        }

        // ã€Œã‚µã‚¤ãƒ³ã‚¤ãƒ³ã€ã«ã¤ã„ã¦
        const signIn = $("#signIn");
        const signUp = $("#signUp");

        // ã€Œã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã€ãƒœã‚¿ãƒ³ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        signUp.on("click", function () {
            if (user_id.length >= 1) {
                $.ajax({
                    url: "/signout",
                    type: "POST",
                    async: true
                });

                document.cookie = "user_id=;";
                window.location.href = "/index.html";
            } else {
                window.location.href = "/signup.html";
            }
        });

        // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ¸ˆã¿ã®å ´åˆã®å¤‰æ›´
        if (user_id.length >= 1) {
            signUp.text("ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ");
            signUp.prop("class", "col-2 me-3 btn btn-outline-danger");
            signIn.text(user_id + " ã•ã‚“");
            signIn.removeAttr("href");
            elemUserName.val(user_id);
        }

        // å…¥åŠ›å¿…é ˆãªé …ç›®ãŒç©ºã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹
        function checkEmpty() {
            const b1 = elemLatitude.val().length > 0;
            const b2 = elemLongitude.val().length > 0;
            const b3 = elemPhoto.prop("files").length > 0;

            elemSendForm.prop("disabled", !(b1 && b2 && b3));
        }

        // ã€Œç¾åœ¨ä½ç½®ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å®Ÿè¡Œã•ã‚Œã‚‹
        $("#getLocation").on("click", function () {
            const options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            };

            function success(pos) {
                const coords = pos.coords;
                document.querySelector("#latitudeInput").value = coords.latitude;
                document.querySelector("#longitudeInput").value = coords.longitude;
                mymap.setView([coords.latitude, coords.longitude], 17);
            }

            function error(err) {
                const msg = "ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ\n" + `Error Code: ${err.code}\n` + `${err.message}`
                alert(msg);
            }

            navigator.geolocation.getCurrentPosition(success, error, options);

            checkEmpty();
        });

        // ã€Œé€ä¿¡ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å®Ÿè¡Œã•ã‚Œã‚‹
        elemSendForm.on("click", function () {
            $("#successMessage").prop("style", "color: green; display: inline");
            // è¦ç´ 
            let id = 0;
            const user_id = $("#userNameInput").val();
            const lat = $("#latitudeInput").val();
            const long = $("#longitudeInput").val();
            const formatted = new Date().toISOString();
            const date = formatted.split(".")[0];

            $.ajax({
                url: "/posts",
                type: "GET",
                async: true
            }).done(function (msg) {
                const tmp = JSON.stringify(msg);
                const json = JSON.parse(tmp);
                id = json.length + 1;
                const jsonString = JSON.stringify({id, user_id, lat, long, photo, date});

                $.ajax({
                    url: "/posts",
                    type: "POST",
                    async: true,
                    contentType: "application/json",
                    data: jsonString,
                    dataType: "json"
                }).done(function () {
                    // æŠ•ç¨¿ãŒçµ‚ã‚ã£ãŸã‚‰ãƒªãƒ­ãƒ¼ãƒ‰
                    location.reload();
                });
            });
        });

        var show=0;
        let requestURL = '/posts';
        let request = new XMLHttpRequest();
        request.open('GET', requestURL);
        request.responseType = 'json';
        request.send();
        request.onload = function() {
            show = request.response;

            var markers =[];
            mymap = L.map('map');
            // ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆã—ã€åœ°å›³ã«ã‚»ãƒƒãƒˆã™ã‚‹
            L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">å›½åœŸåœ°ç†é™¢</a>',
            }).addTo(mymap);
            //markerListã®è¨­å®šã§ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            for (var num in show) {
                var shosai = show[num];
                console.log(shosai)
                const content = `
                    <p>
                        <i class="bi-pin-map-fill"></i>
                        <span><b>ãƒ”ãƒ³ã®è©³ç´°</b></span>
                    </p>
                    <img src="${shosai.photo}" width='300' height='flex' alt="Posted Image">
                    <p><b>æŠ•ç¨¿è€…:<b> ${shosai.user_id}</p>
                    <p><b>ç·¯åº¦:<b> ${shosai.lat}</p>
                    <p><b>çµŒåº¦:<b> ${shosai.long}</p>
                    <p><b>æŠ•ç¨¿æ—¥æ™‚:<b> ${shosai.date}</p>
                `;

                var popup = L.popup({maxWidth:350}).setContent(content);
                markers[num]=L.marker([shosai.lat, shosai.long], { title: shosai.user_id }).bindPopup(popup).addTo(mymap).on( 'click', function(e) {  clickEvt(e); });
                markers[num].user = shosai.user_id;
                markers[num].lat = shosai.lat;
                markers[num].lng = shosai.long;
                markers[num].date = shosai.date;

            }

            // åœ°å›³ã®ä¸­å¿ƒåº§æ¨™ã¨ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®šã™ã‚‹
            mymap.setView([35.943306, 136.200500], 17);
        }

        //ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯
        function clickEvt(e){
            document.getElementById("user").innerHTML = "ãƒ¦ãƒ¼ã‚¶ãƒ¼:"+e.target.user;
            document.getElementById("lat").innerHTML = "ç·¯åº¦:"+e.target.lat;
            document.getElementById("lng").innerHTML = "çµŒåº¦"+e.target.lng;
            document.getElementById("date").innerHTML = "æ—¥æ™‚:"+e.target.date;
        }

    });

    /*
    const btn = document.querySelector('.btn-menu');
    const nav = document.querySelector('nav');
    //  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰
    btn.addEventListener('click', () => {
        nav.classList.toggle('open-menu')
        if (document.all.list.style.display == "none") {
            document.all.list.style.display = "block"
        } else {
            document.all.list.style.display = "none"
        }
    });
     */

</script>
</body>

</html>