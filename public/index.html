<!DOCTYPE html>
<html lang="jp">
<head>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <meta charset="UTF-8">
    <title>テスト入力フォーム</title>
</head>

<body>
  <div class="sidebar">
    <h1>テスト入力フォーム</h1>

    <div class="col-5 mb-3">
        <label for="userNameInput" class="form-label"><b>名前</b></label>
        <input type="text" class="form-control" id="userNameInput">
    </div>

    <div class="col-2 mb-3">
        <label for="latitudeInput">
            <span class="required">*</span>
            <span><b>緯度</b></span> <br>
        </label>
        <input type="number" class="form-control" id ="latitudeInput" min="-90.0" max="90.0" step="0.0000001" required>
    </div>

    <div class="col-2 mb-3">
        <label for="longitudeInput">
            <span class="required">*</span>
            <span><b>経度</b></span> <br>
        </label>
        <input type="number" class="form-control" id ="longitudeInput" min="-180.0" max="180.0" step="0.0000001" required>
    </div>

    <div class="col-2 mb-3">
        <button id="getLocation" class="btn btn-secondary">現在位置を取得</button>
    </div>

    <div class="col-5 mb-3">
        <label for="photoInput">
            <span class="required">*</span>
            <span><b>自動販売機の写真</b></span>
        </label>
        <input type="file" class="form-control" id="photoInput" accept="image/*" required>

        <img id="thumbnail" class="img-thumbnail" alt="サムネイル" src="" hidden>
    </div>

    <div class="col-2 mb-3">
        <button id="sendForm" class="btn btn-success" disabled>送信</button>
    </div>

    <div class="col-4 mb-3">
        <label for="debug"><span><b>デバッグ用</b></span></label>
        <textarea id="debug" class="form-control" rows="15" cols="60"></textarea>
    </div>
  </div>
  <div class="map">
    <div id="map"></div>
  </div>

    <script type="module">
        $(function () {
            // 要素
            const elemUserName = $("#userNameInput");
            const elemLatitude = $("#latitudeInput");
            const elemLongitude = $("#longitudeInput");
            const elemPhoto = $("#photoInput");
            const elemSendForm = $("#sendForm");

            elemPhoto.on("change", checkEmpty);
            elemLatitude.on("input", checkEmpty);
            elemLongitude.on("input", checkEmpty);

            // 入力必須な項目が空かどうかを判定する
            function checkEmpty() {
                const b1 = elemLatitude.val().length > 0;
                const b2 = elemLongitude.val().length > 0;
                const b3 = elemPhoto.prop("files").length > 0;

                elemSendForm.prop("disabled", !(b1 && b2 && b3));
            }

            // 「現在位置を取得」ボタンを押すと実行される
            $("#getLocation").on("click", function () {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                };

                function success(pos) {
                    const coords = pos.coords;
                    document.querySelector("#latitudeInput").value = coords.latitude;
                    document.querySelector("#longitudeInput").value = coords.longitude;
                    mymap.setView([coords.latitude, coords.longitude], 17);
                }

                function error(err) {
                    const msg = "位置情報の取得に失敗しました\n" + `Error Code: ${err.code}\n` + `${err.message}`
                    alert(msg);
                }

                navigator.geolocation.getCurrentPosition(success, error, options);

                checkEmpty();
            });

            // 「送信」ボタンを押すと実行される
            elemSendForm.on("click", function () {
                // 要素
                const userName = $("#userNameInput").val();
                const latitude = $("#latitudeInput").val();
                const longitude = $("#longitudeInput").val();
                const photo = $("#photoInput").prop("files")[0];

                const jsonString = JSON.stringify({userName, latitude, longitude, photo});
                $.ajax({
                    url: "/submit",
                    type: "POST",
                    async: true,
                    contentType: "application/json",
                    data: jsonString,
                    dataType: "json"
                });

                console.log("[FormJSON]\n" + jsonString);
                $("#debug").val(jsonString);
            });

          var testList = [
            {
              "user_id": "hoge-hoge",
              "lat": "35",
              "long": "135",
              "photo": "codimg.png",
              "date": "1/1"
            },
            {
              "user_id": "huge-huge",
              "lat": "35.710049612769694",
              "long": "139.81072185539296",
              "photo": "https://tderfuecifzjrpfwsplc.supabase.co/storage/v1/object/public/hogehoge/test.jpeg",
              "date": "12/31"
            }
          ];

          var mymap = L.map('map');
          // タイルレイヤーを作成し、地図にセットする
          L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">国土地理院</a>',
          }).addTo(mymap);
                //markerListの設定でマーカーを追加
          for (var num in testList) {
            var test = testList[num];
            var content = "<img src= "+ test.photo +" width='300' height='flex'>"
            var popup = L.popup({maxWidth:350}).setContent(content);
            L.marker([test.lat, test.long], { title: test.user_id }).bindPopup(popup).addTo(mymap);
          }
          // 地図の中心座標とズームレベルを設定する
          mymap.setView([35.943306, 136.200500], 17);

        });
    </script>

    <script src="js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</body>

</html>