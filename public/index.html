<!DOCTYPE html>
<html lang="jp">
<head>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
    <meta charset="UTF-8">
    <title>テスト入力フォーム</title>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/index.html">Vending Machine Searcher(仮)</a>
        </div>
        <button id="signUp" class="col-2 me-3 btn btn-outline-secondary" type="button">サインアップ</button>
        <a id="signIn" href="/signin.html" class="col-2" style="text-align: center">サインイン</a>
    </nav>

    <h1>テスト入力フォーム</h1>

    <div class="col-5 mb-3">
        <label for="userNameInput" class="form-label"><b>名前</b></label>
        <input type="text" class="form-control" id="userNameInput">
    </div>

    <div class="col-2 mb-3">
        <label for="latitudeInput">
            <span class="required">*</span>
            <span><b>緯度</b></span> <br>
        </label>
        <input type="number" class="form-control" id ="latitudeInput" min="-90.0" max="90.0" step="0.0000001" required>
    </div>

    <div class="col-2 mb-3">
        <label for="longitudeInput">
            <span class="required">*</span>
            <span><b>経度</b></span> <br>
        </label>
        <input type="number" class="form-control" id ="longitudeInput" min="-180.0" max="180.0" step="0.0000001" required>
    </div>

    <div class="col-2 mb-3">
        <button id="getLocation" class="btn btn-secondary">現在位置を取得</button>
    </div>

    <div class="col-5 mb-3">
        <label for="photoInput">
            <span class="required">*</span>
            <span><b>自動販売機の写真</b></span>
        </label>
        <input type="file" class="form-control" id="photoInput" accept="image/*" required>

        <img id="thumbnail" class="img-thumbnail" alt="サムネイル" src="" hidden>
    </div>

    <div class="col-2 mb-3">
        <button id="sendForm" class="btn btn-success" disabled>送信</button>
    </div>

    <div class="col-4 mb-3">
        <label for="debug"><span><b>デバッグ用</b></span></label>
        <textarea id="debug" class="form-control" rows="15" cols="60"></textarea>
    </div>

    <script type="module">
        // ランダムなUUIDの生成
        function randomUUID(){
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(a) {
                let r = (new Date().getTime() + Math.random() * 16)%16 | 0, v = a === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        $(function () {
            // 要素
            const elemUserName = $("#userNameInput");
            const elemLatitude = $("#latitudeInput");
            const elemLongitude = $("#longitudeInput");
            const elemPhoto = $("#photoInput");
            const elemSendForm = $("#sendForm");

            elemPhoto.on("change", checkEmpty);
            elemLatitude.on("input", checkEmpty);
            elemLongitude.on("input", checkEmpty);

            // Cookie からユーザーIDを取得
            const array = document.cookie.split(";");
            let user_id = "";
            for (const c of array) {
                const split = c.split("=");
                const key = split[0];
                const value = split[1];

                if (key === "user_id") {
                    user_id = value;
                    break;
                }
            }

            // 「サインアップ」ボタンでリダイレクト
            // 「サインイン」について
            const signIn = $("#signIn");
            const signUp = $("#signUp");

            signUp.on("click", function () {
                if (user_id.length >= 1) {
                    $.ajax({
                        url: "/signout",
                        type: "POST",
                        async: true
                    });

                    document.cookie = "user_id=;";
                    window.location.href = "/index.html";
                } else {
                    window.location.href = "/signup.html";
                }
            });

            if (user_id.length >= 1) {
                signUp.text("サインアウト");
                signUp.prop("class", "col-2 me-3 btn btn-outline-danger");
                signIn.text(user_id + " さん");
                signIn.removeAttr("href");
                elemUserName.val(user_id);
            }

            // 入力必須な項目が空かどうかを判定する
            function checkEmpty() {
                const b1 = elemLatitude.val().length > 0;
                const b2 = elemLongitude.val().length > 0;
                const b3 = elemPhoto.prop("files").length > 0;

                elemSendForm.prop("disabled", !(b1 && b2 && b3));
            }

            // 「現在位置を取得」ボタンを押すと実行される
            $("#getLocation").on("click", function () {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                };

                function success(pos) {
                    const coords = pos.coords;
                    document.querySelector("#latitudeInput").value = coords.latitude;
                    document.querySelector("#longitudeInput").value = coords.longitude;
                }

                function error(err) {
                    const msg = "位置情報の取得に失敗しました\n" + `Error Code: ${err.code}\n` + `${err.message}`
                    alert(msg);
                }

                navigator.geolocation.getCurrentPosition(success, error, options);

                checkEmpty();
            });

            // 「送信」ボタンを押すと実行される
            elemSendForm.on("click", function () {
                // 要素
                let id = 0;
                const user_id = $("#userNameInput").val();
                const lat = $("#latitudeInput").val();
                const long = $("#longitudeInput").val();
                const photo = randomUUID();
                const formatted = new Date().toISOString();
                const date = formatted.split(".")[0];

                $.ajax({
                    url: "/posts",
                    type: "GET",
                    async: true
                }).done(function (msg) {
                    const tmp = JSON.stringify(msg);
                    const json = JSON.parse(tmp);
                    id = json.length + 1;

                    const jsonString = JSON.stringify({id, user_id, lat, long, photo, date});
                    $.ajax({
                        url: "/posts",
                        type: "POST",
                        async: true,
                        contentType: "application/json",
                        data: jsonString,
                        dataType: "json"
                    });

                    $("#debug").val(jsonString);
                });
            });
        });
    </script>

    <script src="js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</body>

</html>